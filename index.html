<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹•è©å¤‰å½¢ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f8ff;
            padding: 10px;
            touch-action: manipulation;
        }

        #game-container {
            width: 95%;
            max-width: 600px;
            background-color: #ffffff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333366;
            text-align: center;
            font-size: 1.5em;
        }

        p {
            font-size: 0.9em;
            text-align: center;
        }
        
        #info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        #timer-box, #score-box {
            padding: 8px 15px;
            background-color: #ffcc00;
            color: #333;
            font-weight: bold;
            border-radius: 5px;
            text-align: center;
            font-size: 1.2em;
            flex: 1;
            margin: 0 5px;
        }

        .time-low {
            background-color: #ff7f50 !important;
        }

        #puzzle-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .puzzle-piece {
            background-color: #add8e6;
            color: #333;
            padding: 15px 5px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #333366;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            opacity: 1;
            transition: opacity 0.3s ease-out;
        }

        .puzzle-piece:active {
            transform: scale(0.98);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .selected {
            border: 4px solid #ff6347;
            background-color: #ffdab9;
        }

        #message {
            margin-top: 15px;
            font-size: 1.1em;
            font-weight: bold;
            min-height: 25px;
            text-align: center;
        }

        #button-area {
            margin-top: 20px;
            display: flex;
            justify-content: space-around;
            width: 100%;
        }

        .action-button {
            padding: 12px 15px;
            font-size: 1.1em;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            flex: 1;
            margin: 0 5px;
            transition: background-color 0.3s;
        }

        #start-button {
            background-color: #4CAF50;
        }
        #start-button:hover {
            background-color: #45a049;
        }

        #next-button {
            background-color: #007bff;
        }
        #next-button:hover {
            background-color: #0056b3;
        }

        #restart-button {
            background-color: #dc3545;
        }
        #restart-button:hover {
            background-color: #c82333;
        }

        .correct {
            background-color: #90ee90;
            color: #1a4f1a;
            pointer-events: none;
        }
        
        .disabled {
            pointer-events: none;
            opacity: 0.5;
        }
        
        /* ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>å‹•è©å¤‰å½¢ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h1>
        
        <div id="info-bar">
            <div id="timer-box">æ®‹ã‚Šæ™‚é–“: 5:00</div>
            <div id="score-box">æ­£è§£æ•°: 0 å•</div>
        </div>

        <p>âœ¨ **é †åºã«æ³¨æ„ï¼** åŸå½¢ â†’ éå»å½¢ â†’ éå»åˆ†è©ã®é †ã«ã‚¿ãƒƒãƒ—ã—ã¦ã€æ­£ã—ã„å‹•è©ã‚»ãƒƒãƒˆã‚’2çµ„è¦‹ã¤ã‘ã‚ˆã†ï¼<br>ï¼ˆä¾‹å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯é †åºãŒè‡ªç”±ã«ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰</p>

        <div id="puzzle-grid">
            </div>

        <div id="message"></div>

        <div id="button-area">
            <button id="next-button" class="action-button hidden">æ¬¡ã®ãƒ‘ã‚ºãƒ«ã¸</button>
            <button id="restart-button" class="action-button">ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        </div>
        
    </div>

    <div id="start-screen">
        <h2 style="color: #333366;">5åˆ†é–“ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼</h2>
        <p style="font-size: 1.1em; margin-bottom: 30px;">ã©ã‚Œã ã‘å¤šãã®å‹•è©ã‚»ãƒƒãƒˆã‚’è§£ã‘ã‚‹ã‹è©¦ã—ã¦ã¿ã‚ˆã†ï¼</p>
        <button id="start-button" class="action-button" style="width: 180px; padding: 12px 25px;">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

// ä¸­å­¦æ ¡ã§å­¦ç¿’ã™ã‚‹ä¸»è¦ãªä¸è¦å‰‡å‹•è©ãƒªã‚¹ãƒˆ (å¤‰æ›´ãªã—)
const ALL_VERB_SETS = [
    ["be", "was/were", "been"], 
    ["become", "became", "become"],
    ["begin", "began", "begun"],
    ["break", "broke", "broken"],
    ["bring", "brought", "brought"],
    ["buy", "bought", "bought"],
    ["come", "came", "come"],
    ["cut", "cut", "cut"],
    ["do", "did", "done"],
    ["draw", "drew", "drawn"],
    ["drink", "drank", "drunk"],
    ["drive", "drove", "driven"],
    ["eat", "ate", "eaten"],
    ["fall", "fell", "fallen"],
    ["feel", "felt", "felt"],
    ["find", "found", "found"],
    ["fly", "flew", "flown"],
    ["get", "got", "gotten"],
    ["give", "gave", "given"],
    ["go", "went", "gone"],
    ["have", "had", "had"],
    ["hear", "heard", "heard"],
    ["keep", "kept", "kept"],
    ["know", "knew", "known"],
    ["leave", "left", "left"],
    ["make", "made", "made"],
    ["meet", "met", "met"],
    ["read", "read", "read"],
    ["run", "ran", "run"],
    ["say", "said", "said"],
    ["see", "saw", "seen"],
    ["send", "sent", "sent"],
    ["sing", "sang", "sung"],
    ["sleep", "slept", "slept"],
    ["speak", "spoke", "spoken"],
    ["stand", "stood", "stood"],
    ["swim", "swam", "swum"],
    ["take", "took", "taken"],
    ["tell", "told", "told"],
    ["think", "thought", "thought"],
    ["wear", "wore", "worn"],
    ["write", "wrote", "written"]
];

const TIME_LIMIT_SECONDS = 300; 

// DOMè¦ç´ ã®å–å¾—
const grid = document.getElementById('puzzle-grid');
const message = document.getElementById('message');
const timerBox = document.getElementById('timer-box');
const scoreBox = document.getElementById('score-box');
const startScreen = document.getElementById('start-screen');
const startButton = document.getElementById('start-button');
const nextButton = document.getElementById('next-button');
const restartButton = document.getElementById('restart-button');

// ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹å¤‰æ•°
let allVerbSetsCopy = [...ALL_VERB_SETS];
let currentVerbSet = [];
let allPieces = [];
let selectedPieces = [];
let correctSetsFound = 0;
let totalScore = 0;
let timerInterval;
let gameIsRunning = false;
let timeLeft = TIME_LIMIT_SECONDS;

// --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

/**
 * ãƒ€ãƒŸãƒ¼å˜èªã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
 */
function generateDummyWord(baseWord, usedWords) {
    let dummy = '';
    let attempts = 0;
    
    while (dummy === '' || usedWords.includes(dummy) || dummy.length < 2) {
        attempts++;
        if (attempts > 10) return baseWord + 'x'; // å¤±æ•—ã—ãŸã‚‰è«¦ã‚ã¦ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚‚ã®ã‚’è¿”ã™
        
        if (Math.random() < 0.3 && baseWord.length > 2) {
            dummy = baseWord + (Math.random() < 0.5 ? 'ed' : 'en');
        } else if (Math.random() < 0.6 && baseWord.length > 2) {
            const vowels = ['a', 'e', 'i', 'o', 'u'];
            let foundVowel = false;
            dummy = baseWord.replace(/[aeiou]/g, function(vowel) {
                if (foundVowel || Math.random() < 0.5) return vowel;
                foundVowel = true;
                let newVowel = vowels[Math.floor(Math.random() * vowels.length)];
                return (newVowel === vowel) ? (vowels[(vowels.indexOf(vowel) + 1) % vowels.length]) : newVowel;
            });
        } else {
            dummy = baseWord.substring(0, baseWord.length - 1);
        }
        
        if (dummy.toLowerCase() === baseWord.toLowerCase()) {
            dummy = ''; 
        }
    }
    
    return dummy;
}

const ENCOURAGEMENT_MESSAGES = [
    "ğŸ”¥ ã„ã„èª¿å­ï¼é›†ä¸­ã§ãã¦ã‚‹ã­ï¼",
    "ğŸ‘ æ­£è§£ï¼ã©ã‚“ã©ã‚“é€²ã‚‚ã†ï¼",
    "ğŸŒŸ ãã®èª¿å­ã§æ¬¡ã‚‚é ‘å¼µã‚ã†ï¼",
    "ğŸ˜Š è½ã¡ç€ã„ã¦ã€æ¬¡ã®å‹•è©ã‚’ã‚ˆãè¦‹ã¦ã€‚",
    "ğŸ’¯ ãƒŠã‚¤ã‚¹ï¼è¨˜æ†¶ãŒå®šç€ã—ã¦ã‚‹è¨¼æ‹ ã ã‚ˆï¼"
];

const FAILURE_MESSAGES = [
    "ğŸ™…â€â™‚ï¸ é †åºã‹çµ„ã¿åˆã‚ã›ãŒé•ã„ã¾ã™ã€‚åŸå½¢ â†’ éå»å½¢ â†’ éå»åˆ†è©ã®é †ã§ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„ï¼",
    "ğŸ˜Ÿ æƒœã—ã„ï¼ä¸€ã¤ã ã‘é•ã£ãŸã‹ã‚‚ï¼Ÿ",
    "ğŸ’¡ å¤‰åŒ–ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ€ã„å‡ºã—ã¦ï¼"
];


// --- ã‚¿ã‚¤ãƒãƒ¼é–¢é€£ã®é–¢æ•° (å¤‰æ›´ãªã—) ---

function updateTimer() {
    const minutes = Math.floor(timeLeft / 60);
    const remainingSeconds = timeLeft % 60;
    timerBox.textContent = `æ®‹ã‚Šæ™‚é–“: ${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 60 && timeLeft > 0) {
        timerBox.classList.add('time-low');
    } else {
        timerBox.classList.remove('time-low');
    }
}

function startTimer() {
    if (timerInterval) clearInterval(timerInterval);

    timerInterval = setInterval(() => {
        timeLeft--;
        updateTimer();

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            endGame();
        }
    }, 1000);
}

// --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã®é–¢æ•° ---

function startGame() {
    startScreen.classList.add('hidden');
    gameIsRunning = true;
    totalScore = 0;
    timeLeft = TIME_LIMIT_SECONDS;
    updateTimer();
    scoreBox.textContent = `æ­£è§£æ•°: ${totalScore} å•`;
    
    allVerbSetsCopy = [...ALL_VERB_SETS];
    shuffleArray(allVerbSetsCopy);
    
    initializePuzzle();
    
    startTimer();
    
    nextButton.classList.add('hidden');
    restartButton.textContent = 'ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ';
}

function initializePuzzle() {
    grid.innerHTML = '';
    message.textContent = 'åŸå½¢ â†’ éå»å½¢ â†’ éå»åˆ†è©ã®ã‚»ãƒƒãƒˆã‚’2çµ„è¦‹ã¤ã‘ã‚ˆã†ï¼';
    selectedPieces = [];
    allPieces = [];
    correctSetsFound = 0;
    
    grid.classList.remove('disabled');
    nextButton.classList.add('hidden');

    if (allVerbSetsCopy.length < 2) {
        allVerbSetsCopy = [...ALL_VERB_SETS];
        shuffleArray(allVerbSetsCopy);
    }
    
    const setIndex1 = allVerbSetsCopy.pop();
    const setIndex2 = allVerbSetsCopy.pop();
    currentVerbSet = [setIndex1, setIndex2];

    let pieceIdCounter = 0;
    let correctWords = []; // ãƒ€ãƒŸãƒ¼ç”Ÿæˆã®ãŸã‚ã«ä½¿ç”¨ä¸­ã®æ­£è§£å˜èªã‚’åé›†

    currentVerbSet.forEach((set, setIndex) => {
        set.forEach((verb, typeIndex) => {
            allPieces.push({ 
                word: verb, 
                correctOrder: typeIndex,
                isDummy: false,
                setIndex: setIndex,
                id: pieceIdCounter++,
                originalSet: set 
            });
            correctWords.push(verb);
        });
    });

    // 3. ãƒ€ãƒŸãƒ¼ãƒ”ãƒ¼ã‚¹ 3ã¤ ã‚’ä½œæˆ
    for (let i = 0; i < 3; i++) {
        const baseWord = currentVerbSet[0][i]; 
        const dummyWord = generateDummyWord(baseWord, correctWords);
        allPieces.push({
            word: dummyWord,
            correctOrder: -1,
            isDummy: true,
            setIndex: -1,
            id: pieceIdCounter++
        });
    }

    shuffleArray(allPieces);

    allPieces.forEach(pieceData => {
        const piece = document.createElement('div');
        piece.classList.add('puzzle-piece');
        piece.textContent = pieceData.word;
        piece.dataset.id = pieceData.id;
        piece.addEventListener('click', () => handlePieceClick(piece, pieceData));
        grid.appendChild(piece);
    });
}

function handlePieceClick(piece, pieceData) {
    if (!gameIsRunning || piece.classList.contains('correct') || selectedPieces.includes(piece)) {
        return; 
    }

    piece.classList.add('selected');
    selectedPieces.push(piece);

    if (selectedPieces.length === 3) {
        checkCombination();
    }
}

/**
 * é¸æŠã•ã‚ŒãŸ3ã¤ã®ãƒ”ãƒ¼ã‚¹ã®çµ„ã¿åˆã‚ã›ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
 */
function checkCombination() {
    const selectedData = selectedPieces.map(p => allPieces.find(d => d.id == p.dataset.id));
    
    let isCorrectSet = false;
    let isCorrectOrder = false;
    
    // 1. åŸºæœ¬çš„ãªè¦ç´ ãƒã‚§ãƒƒã‚¯ (ãƒ€ãƒŸãƒ¼ãªã—ã€åŒã˜ã‚»ãƒƒãƒˆã€3å½¢ãŒæƒã£ã¦ã„ã‚‹ã‹)
    const allNotDummy = selectedData.every(data => data.isDummy === false);
    
    if (allNotDummy) {
        const firstSetIndex = selectedData[0].setIndex;
        const sameSetIndex = selectedData.every(data => data.setIndex === firstSetIndex);
        
        const orders = selectedData.map(data => data.correctOrder).sort();
        const correctFormsCount = orders[0] === 0 && orders[1] === 1 && orders[2] === 2;

        if (sameSetIndex && correctFormsCount) {
            
            // 2. é †åºãƒã‚§ãƒƒã‚¯ (ãƒ«ãƒ¼ãƒ«é©ç”¨)
            const tappedOrders = selectedData.map(data => data.correctOrder);
            const originalSet = selectedData[0].originalSet; 
            const baseForm = originalSet[0];
            const pastForm = originalSet[1];
            const pastParticipleForm = originalSet[2];
            
            // --- é †åºåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
            
            // A. ã™ã¹ã¦åŒå½¢ (cut-cut-cut, read-read-readãªã©)
            if (baseForm === pastForm && pastForm === pastParticipleForm) {
                isCorrectOrder = true; // é †åºã¯å•ã‚ãªã„
            } 
            // B. åŸå½¢ã¨éå»åˆ†è©ãŒåŒå½¢ (come-came-come, run-ran-runãªã©)
            else if (baseForm === pastParticipleForm && baseForm !== pastForm) {
                // åŸå½¢(0)ã¨éå»åˆ†è©(2)ãŒæœ€åˆã¨æœ€å¾Œã®ã©ã¡ã‚‰ã‹ã€éå»å½¢(1)ãŒçœŸã‚“ä¸­
                // é †åºã¯ (0, 1, 2) ã¾ãŸã¯ (2, 1, 0)
                if (tappedOrders[0] === 0 && tappedOrders[1] === 1 && tappedOrders[2] === 2) {
                    isCorrectOrder = true; // åŸå½¢â†’éå»å½¢â†’éå»åˆ†è©
                } else if (tappedOrders[0] === 2 && tappedOrders[1] === 1 && tappedOrders[2] === 0) {
                    isCorrectOrder = true; // éå»åˆ†è©â†’éå»å½¢â†’åŸå½¢ (ä¾‹å¤–è¨±å¯)
                }
            }
            // C. éå»å½¢ã¨éå»åˆ†è©ãŒåŒå½¢ (bring-brought-brought, say-said-saidãªã©)
            else if (pastForm === pastParticipleForm && baseForm !== pastForm) {
                // é †åºã¯ (0, 1, 2) ã¾ãŸã¯ (0, 2, 1)
                const isStrictOrder = tappedOrders[0] === 0 && tappedOrders[1] === 1 && tappedOrders[2] === 2;
                const isFlexibleOrder = tappedOrders[0] === 0 && tappedOrders[1] === 2 && tappedOrders[2] === 1;
                
                if (isStrictOrder || isFlexibleOrder) {
                    isCorrectOrder = true;
                }
            }
            // D. å…¨ã¦ç•°ãªã‚‹å½¢ (write-wrote-writtenãªã©)
            else {
                // å³æ ¼ãªé †åº (0, 1, 2) ã®ã¿
                if (tappedOrders[0] === 0 && tappedOrders[1] === 1 && tappedOrders[2] === 2) {
                    isCorrectOrder = true;
                }
            }
            
            isCorrectSet = isCorrectOrder;
        }
    }


    if (isCorrectSet) {
        message.textContent = ENCOURAGEMENT_MESSAGES[Math.floor(Math.random() * ENCOURAGEMENT_MESSAGES.length)];
        correctSetsFound++;
        totalScore++;
        scoreBox.textContent = `æ­£è§£æ•°: ${totalScore} å•`;

        selectedPieces.forEach(p => {
            p.classList.remove('selected');
            p.classList.add('correct');
        });
        
        if (correctSetsFound === 2) {
            message.textContent = `ğŸ‰ 2çµ„æ­£è§£ï¼ãŠè¦‹äº‹ï¼ æ¬¡ã®ãƒ‘ã‚ºãƒ«ã¸é€²ã‚‚ã†ï¼`;
            grid.classList.add('disabled');
            nextButton.classList.remove('hidden');
        }
    } else {
        message.textContent = FAILURE_MESSAGES[Math.floor(Math.random() * FAILURE_MESSAGES.length)];
    }

    // å‡¦ç†å¾Œã€é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    setTimeout(() => {
        if (!isCorrectSet) {
            selectedPieces.forEach(p => p.classList.remove('selected'));
        }
        selectedPieces = [];
    }, 1000); 
}

function endGame() {
    clearInterval(timerInterval);
    gameIsRunning = false;
    grid.classList.add('disabled');
    timerBox.classList.remove('time-low');

    message.innerHTML = `â±ï¸ **ã‚¿ã‚¤ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼** â±ï¸<br>ã‚ãªãŸã®è¨˜éŒ²ã¯ **${totalScore} å•** ã§ã—ãŸã€‚`;
    timerBox.textContent = "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼";
    
    nextButton.classList.add('hidden');
    restartButton.textContent = 'ã‚‚ã†ä¸€åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼';
    
    startScreen.classList.remove('hidden');
    startScreen.querySelector('h2').textContent = `æœ€çµ‚ã‚¹ã‚³ã‚¢: ${totalScore} å•ï¼`;
    startScreen.querySelector('p').textContent = `ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã€ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°ã—ã‚ˆã†ï¼`;
}

// --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---

startButton.addEventListener('click', startGame);

nextButton.addEventListener('click', () => {
    if (!gameIsRunning) return;
    grid.classList.remove('disabled');
    nextButton.classList.add('hidden');
    initializePuzzle();
});

restartButton.addEventListener('click', () => {
    endGame();
});

// åˆæœŸåŒ–å‡¦ç†
initializePuzzle(); 
grid.classList.add('disabled');
updateTimer();
nextButton.classList.add('hidden');
restartButton.textContent = 'ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ';

});
</script>
</body>
</html>